# ì‹¤ìŠµ

### CodeBuild ë° Codepipeline ì†Œê°œ


### GitHub Repo Clone

- ì‹¤ìŠµì— í•„ìš”í•œ ìë£Œë¥¼ GitHubë¥¼ í†µí•´ Clone

```yaml
$ git clone https://github.com/koDaegon/book-sample.git
```

### Cloudformationì„ í†µí•´ ê¸°ë³¸ CI/CD íŒŒì´í”„ë¼ì¸ ë°°í¬

- CFN/pipeline-setup.yaml ì„ í™•ì¸í•˜ì—¬ Cloudformationì„ í†µí•´ ì–´ë–¤ AWS ë¦¬ì†ŒìŠ¤ê°€ ë°°í¬ë˜ëŠ”ì§€ í™•ì¸
- í•´ë‹¹ íŒŒì¼ì„ ë³µì‚¬í•˜ê³  1-pipeline-base.yaml íŒŒì¼ì„ ìƒì„±í•˜ê³  aws í™˜ê²½ì— ë°°í¬
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%200.png)
    

- Stack Parameterì— base-stackì˜ Outputs ê°’ì„ ì°¸ì¡°í•˜ì—¬ ArtifactBucket / PipelineServiceRoleArn  ê°’ì„ ì…ë ¥
- RepositoryNameì—ëŠ” Sample Book applicationì´ ì˜¬ë¼ê°€ê²Œë  Repository ì´ë¦„ ì…ë ¥ í›„ Cloudformation ë°°í¬
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%201.png)
    

- CloudFormation ë°°í¬ê°€ ì™„ë£Œ ë˜ì—ˆë‹¤ë©´ Resource íƒ­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ í™•ì¸
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%202.png)
    

- Codepipeline ìœ¼ë¡œ ì´ë™í•˜ì—¬ íŒŒì´í”„ë¼ì¸ ê¸°ë³¸ êµ¬ì„± í™•ì¸
    
    <aside>
    ğŸ’¡ Codepipline ì‹¤íŒ¨ ì›ì¸??
    
    </aside>
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%203.png)
    

- Codepipeline íŠ¸ë¦¬ê±°ë¥¼ ìœ„í•´ CodeCommit Repo ìƒì„±
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%204.png)
    

- Git remoteë¥¼ CodeCommit Repoë¡œ ë³€ê²½
    
    ```yaml
    $ git remote -v # ë¦¬ëª¨íŠ¸ í™•ì¸
    $ git remote remove origin #origin ë¦¬ëª¨íŠ¸ ì‚­ì œ
    # CodeCommit remote ë“±ë¡
    $ git remote add origin https://git-codecommit.ap-northeast-2.amazonaws.com/v1/repos/book-sample
    $ git remote -v # ë¦¬ëª¨íŠ¸ í™•ì¸
    ```
    
- CodeCommit Repoë¡œ í‘¸ì‹œ
    
    ```yaml
    $ git push origin main
    ```
    
- Repoì— ë³€ê²½ì‚¬í•­ì´ ìˆê¸° ë•Œë¬¸ì— Codepipelineì´ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±° ë˜ì–´ ë™ì‘
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%205.png)
    
- build_scripts ë¡œ ì´ë™í•˜ì—¬ buildspec.build.yamlì— ë¯¸ë¦¬ ì •ì˜ëœ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™•ì¸
    
    ```yaml
    version: 0.2
    env:
      shell: bash
      git-credential-helper: yes
      variables:
        REGION: "ap-northeast-2"
        IMAGE_TAG_KEY: "/book/sample/main/tag"
    phases:
      install:
        runtime-versions:
          java: corretto11
        commands:
          - apt-get update
          - apt-get install -y jq
      pre_build:
        commands:
          - echo "Print awscli version"
          - aws --version
          - export MY_ECR="${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com/${ECR_REPO}"
          - echo "### SRC_VERISON-> ${CODEBUILD_RESOLVED_SOURCE_VERSION} | Logginging to ECR"
          - docker login --username AWS -p $(aws ecr get-login-password --region ${REGION}) ${MY_ECR}
          - export TAG=${CODEBUILD_RESOLVED_SOURCE_VERSION}
          - export TAG=$(echo $TAG | sed -e "s/\.//g"| tr '[:upper:]' '[:lower:]')
          - export TAG=$(echo "${TAG:0:8}")
          - export IMAGE_TAG="${TAG}"
          - export REPOSITORY_URI="${MY_ECR}"
          - echo "## TAG-> ${TAG}"
          - |
            echo "### Start App build ###"
            chmod +x ./gradlew 
            ./gradlew clean build  -x test --no-daemon
      build:
        commands:
          - |
            echo "### Building Container Image ###"
            echo $CODEBUILD_SRC_DIR
            echo Build started on `date`
            echo Building the Docker image...
            docker build -t $REPOSITORY_URI:latest ./
            docker images
            docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
    
          - |
            echo "### Pushing Container Image ###"
            docker push $REPOSITORY_URI:$IMAGE_TAG
          # - cat ./build_scripts/imageDef.json | envsubst > $CODEBUILD_SRC_DIR/imagedefinitions.json
          # - cat $CODEBUILD_SRC_DIR/imagedefinitions.json
      post_build:
        commands:
          - |
            echo "### Pushing Container Image Tag to SSM###"
            aws ssm put-parameter --name $IMAGE_TAG_KEY --value $IMAGE_TAG --overwrite
          - echo "${IMAGE_TAG}" >> build_output.txt
    artifacts:
      files:
        - build_output.txt
    cache:
      paths:
        - '/root/.gradle/caches/**/*'
    ```
    

- buildspec.deploy.yamlì— ë¯¸ë¦¬ ì •ì˜ëœ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ í™•ì¸
    
    ```yaml
    version: 0.2
    env:
      git-credential-helper: yes
      parameter-store:
        ASSUME_ROLE: /eks/role/arn
        IMAGE_TAG: /apprepo/image/main
        PUB_SUB_A: /base/pub/subnet/a
        PUB_SUB_C: /base/pub/subnet/c
    
    phases:
      install:
        commands:
          - echo "Install kubectl ..."
          - curl -LO "https://dl.k8s.io/release/v1.23.16/bin/linux/amd64/kubectl"
          - install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          - curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          - chmod 700 get_helm.sh
          - ./get_helm.sh
      pre_build:
        commands:
          - |
            echo "## Check aws cli and kubectl ##"
            aws --version
            kubectl version --client
            helm version
    
          - export MY_ECR="${AWS_ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${ECR_REPO}"
          - echo ${IMAGE_TAG}
          - echo ${MY_ECR}
          - |
            export ASSUME_SESSION_NAME="codebuild-$(date +%s)"
    
            echo "ASSUME_ROLE_ARN=${ASSUME_ROLE}"
            aws sts assume-role --role-arn ${ASSUME_ROLE} --role-session-name ${ASSUME_SESSION_NAME} --output json > config.json
            
      build:
        commands:
          - |
            echo "Set up eks config ..."
            export AWS_ACCESS_KEY_ID_OLD=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY_OLD=${AWS_SECRET_ACCESS_KEY}
            export AWS_SESSION_TOKEN_OLD=${AWS_SESSION_TOKEN}
    
            export AWS_ACCESS_KEY_ID=$(cat config.json | jq ".Credentials.AccessKeyId" | tr -d '"')
            export AWS_SECRET_ACCESS_KEY=$(cat config.json | jq ".Credentials.SecretAccessKey" | tr -d '"')
            export AWS_SESSION_TOKEN=$(cat config.json | jq ".Credentials.SessionToken" | tr -d '"')
            
            aws eks --region ap-northeast-2 update-kubeconfig --name kdaegon-sds-demo
    
          - |
            echo "### Deploy k8s manifest file"
            kubectl config current-context
            kubectl get pod -A  
            
            cd k8s-manifests
            cat deployment-template.yaml | envsubst > deployment.yaml
            cat ingress-template.yaml | envsubst > ingress.yaml
            
            cat deployment.yaml
            cat ingress.yaml
            
            kubectl apply -f deployment.yaml
            kubectl rollout status deployment deployment-demo -n demo
    
            kubectl apply -f svc.yaml
            kubectl apply -f ingress.yaml
          
          # - cd ${CODEBUILD_SRC_DIR}
    
          # - |
          #   echo "### Deploy helm chart"
            
          #   cd helm
          #   cat ./values-template.yaml | envsubst > ./demo/values.yaml
    
          #   cat ./demo/values.yaml
          #   helm upgrade --install -n test demo ./demo -f ./demo/values.yaml
          #   kubectl rollout status deployment deployment-demo -n test
    
      post_build:
        commands:
          - |
            cd ${CODEBUILD_SRC_DIR}
            echo "Deploy image tag : ${IMAGE_TAG}" > deploy_output.txt
    artifacts:
      files:
        - deploy_output.txt
    ```
    
- íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìƒíƒœ í™•ì¸
    - ì‹¤íŒ¨â€¦.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%206.png)
    
    - ë¡œê·¸ í™•ì¸
        
        ```yaml
        Error Message: parameter does not exist: /eks/role/arn...
        ```
        
    
- Parameter Storeë¡œ ì´ë™í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í•„ìš”í•œ Param ìƒì„±
(/eks/role/arn , /base/pub/subnet/a , /base/pub/subnet/c)
- ì´ë•Œ role arnì€ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•œ c9ì—ì„œ ì‚¬ìš©í•˜ëŠ” role arn ì…ë ¥
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%207.png)
    
- 
    
    
- Codepipelineì„ ë‹¤ì‹œ íŠ¸ë¦¬ê±° í•˜ì—¬ Applicationì„ ë°°í¬
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%208.png)
    
- c9ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì‹¤ì œë¡œ Book Namespaceì— ë¦¬ì†ŒìŠ¤ê°€ ì˜ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
    
    ```yaml
    #Deployment ìƒíƒœ í™•ì¸
    $ kubectl get po -n book
    $ kubectl logs <pod_name> -n book
    
    #Ingress ìƒíƒœ í™•ì¸
    $ kubectl get ingress -n book
    $ kubectl describe ingress ingress-demo -n book
    ```
    
    - ingress ì„¤ì •ì´ ì˜ëª» ì„¤ì • ë¨.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%209.png)
    
- ingress-tample.yaml ë¡œ ì´ë™í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¹˜í™˜ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½ í›„ í‘¸ì‹œ
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%2010.png)
    
    ```yaml
    $ git add .
    $ git commit -m "Updated ingress"
    $ git push origin main
    ```
    

- ë°°í¬ ì™„ë£Œ í›„ c9ë¡œ ëŒì•„ê°€ì„œ ingress ìƒíƒœ í™•ì¸
    
    ```yaml
    $ kubectl get ingress -n book
    ```
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%2011.png)
    
    <aside>
    ğŸ’¡ **ë§Œì•½ Application code ë³€ê²½ ì—†ì´ Deploymentì˜ Replica ê°¯ìˆ˜ë§Œ ë°”ê¾¸ê³  ì‹¶ë‹¤ê±°ë‚˜ í˜¹ì€ ingress ì˜ ì„¤ì •ë§Œ ë³€ê²½ í•˜ê³  ì‹¶ë‹¤ë©´??**
    
    </aside>
    

- 3ë¶„ ì •ë„ ê¸°ë‹¤ë¦° í›„ ingressë¡œ ì ‘ì†í•˜ì—¬ appì´ ì •ìƒì ìœ¼ë¡œ ë°°í¬ ë˜ì—ˆëŠ”ì§€ í™•ì¸ (/swagger-ui/index.html)
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%2012.png)