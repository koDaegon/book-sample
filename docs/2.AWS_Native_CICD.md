# ì‹¤ìŠµ

### CodeBuild ë° Codepipeline ì†Œê°œ
- êµì¬ ì°¸ì¡°

### Cloudformationì„ í†µí•´ ê¸°ë³¸ CI/CD íŒŒì´í”„ë¼ì¸ ë°°í¬

- CFN/1-pipeline-base.yaml ì„ ë‹¤ìš´ë¡œë“œ í›„ Cloudformationì„ í†µí•´ ì–´ë–¤ AWS ë¦¬ì†ŒìŠ¤ê°€ ë°°í¬ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- Cloudformationìœ¼ë¡œ ì´ë™í•˜ì—¬ Template file(1-pipeline-base.yaml) ì—…ë¡œë“œ í•©ë‹ˆë‹¤.
    <img width="1600" alt="Screenshot 2023-05-26 at 12 55 57 AM" src="https://github.com/koDaegon/book-sample/assets/47220755/c4e6cb78-3c38-4a62-8e87-7d30de998d32">
    
- Stack Parameterì— ê°’ ì…ë ¥ í›„ CloudFormation ë°°í¬í•©ë‹ˆë‹¤.
    > **Bucket Nameì€ Unique í•´ì•¼í•¨**
    
    <img width="1614" alt="Screenshot 2023-05-26 at 12 58 01 AM" src="https://github.com/koDaegon/book-sample/assets/47220755/560d8524-6873-45db-86a1-4326da365839">


- CloudFormation ë°°í¬ê°€ ì™„ë£Œ ë˜ì—ˆë‹¤ë©´ Resource íƒ­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ í™•ì¸í•©ë‹ˆë‹¤.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%202.png)
    

- Codepipeline ìœ¼ë¡œ ì´ë™í•˜ì—¬ íŒŒì´í”„ë¼ì¸ ê¸°ë³¸ êµ¬ì„± í™•ì¸í•©ë‹ˆë‹¤.
    
    <aside>
    ğŸ’¡ Codepipline ì‹¤íŒ¨ ì›ì¸ì€ ë¬´ì—‡ ë•Œë¬¸ì¼ê¹Œìš”??
    </aside>
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%203.png)
    

- Codepipeline íŠ¸ë¦¬ê±°ë¥¼ ìœ„í•´ CodeCommit Repositoryë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%204.png)
    

- Gitì˜ Remote Repositoryë¥¼ CodeCommit Repositoryë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
    
    ```
    git remote -v # ë¦¬ëª¨íŠ¸ í™•ì¸
    
    # CodeCommit originremote ë“±ë¡
    git remote add origin https://git-codecommit.ap-northeast-2.amazonaws.com/v1/repos/app-repo
    git remote -v # ë¦¬ëª¨íŠ¸ í™•ì¸

    # Git Config ì„¤ì •ì„ í†µí•´ username ê³¼ emailì„ ë“±ë¡í•©ë‹ˆë‹¤.
    git config --global user.name "YOUR_NAME"
    git config --global user.email "your@email.com"
    git config -l # Git Config í™•ì¸
    ```
    
- CodeCommit Repoë¡œ ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹ í›„ í‘¸ì‹œí•©ë‹ˆë‹¤.
    
    ```
    git add .
    git commit -m "Updated eksctl script"
    git push origin main
    ```
    
- Repoì— ë³€ê²½ì‚¬í•­ì´ ìˆê¸° ë•Œë¬¸ì— Codepipelineì´ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±° ë˜ì–´ ë™ì‘í•©ë‹ˆë‹¤.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%205.png)
    
- build_scripts ë¡œ ì´ë™í•˜ì—¬ buildspec.build.yamlì— ë¯¸ë¦¬ ì •ì˜ëœ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
    
    ```yaml
    version: 0.2
    env:
      shell: bash
      git-credential-helper: yes
    phases:
      install:
        runtime-versions:
          java: corretto11
        commands:
          - apt-get update
          - apt-get install -y jq
      pre_build:
        commands:
          - echo "Print awscli version"
          - aws --version
          - export MY_ECR="${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com/${ECR_REPO}"
          - echo "### SRC_VERISON-> ${CODEBUILD_RESOLVED_SOURCE_VERSION} | Logginging to ECR"
          - docker login --username AWS -p $(aws ecr get-login-password --region ${REGION_NAME}) ${MY_ECR}
          - export TAG=${CODEBUILD_RESOLVED_SOURCE_VERSION}
          - export TAG=$(echo $TAG | sed -e "s/\.//g"| tr '[:upper:]' '[:lower:]')
          - export TAG=$(echo "${TAG:0:8}")
          - export IMAGE_TAG="dev-${TAG}"
          - export REPOSITORY_URI="${MY_ECR}"
          - echo "## TAG-> ${TAG}"
          - |
            echo "### Start App build ###"
            chmod +x ./gradlew 
            ./gradlew clean build  -x test --no-daemon
      build:
        commands:
          - |
            echo "### Building Container Image ###"
            echo $CODEBUILD_SRC_DIR
            echo Build started on `date`
            echo Building the Docker image...
            docker build -t $REPOSITORY_URI:latest ./
            docker images
            docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG

          - |
            echo "### Pushing Container Image ###"
            docker push $REPOSITORY_URI:$IMAGE_TAG
          # - cat ./build_scripts/imageDef.json | envsubst > $CODEBUILD_SRC_DIR/imagedefinitions.json
          # - cat $CODEBUILD_SRC_DIR/imagedefinitions.json
      post_build:
        commands:
          - |
            echo "### Pushing Container Image Tag to SSM###"
            aws ssm put-parameter --name /book/sample/main/tag --value $IMAGE_TAG --type String --region $REGION_NAME --overwrite
          - echo "${IMAGE_TAG}" >> build_output.txt
    artifacts:
      files:
        - build_output.txt
    cache:
      paths:
        - '/root/.gradle/caches/**/*'
    ```
    

- buildspec.deploy.yamlì— ë¯¸ë¦¬ ì •ì˜ëœ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ í™•ì¸í•©ë‹ˆë‹¤.
    
    ```yaml
    version: 0.2
    env:
      git-credential-helper: yes
      parameter-store:
        ASSUME_ROLE: /eks/role/arn
        IMAGE_TAG: /book/sample/main/tag
        PUB_SUB_A: /base/pub/subnet/a
        PUB_SUB_C: /base/pub/subnet/c
      variables:
        CLUSTER_NAME: eks-kdaegon

    phases:
      install:
        commands:
          - echo "Install kubectl ..."
          - curl -LO "https://dl.k8s.io/release/v1.25.10/bin/linux/amd64/kubectl"
          - install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          - curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          - chmod 700 get_helm.sh
          - ./get_helm.sh
      pre_build:
        commands:
          - |
            echo "## Check aws cli and kubectl ##"
            aws --version
            kubectl version --client
            helm version

          - export MY_ECR="${AWS_ACCOUNT_ID}.dkr.ecr.${REGION_NAME}.amazonaws.com/${ECR_REPO}"
          - echo ${IMAGE_TAG}
          - echo ${MY_ECR}
          - |
            export ASSUME_SESSION_NAME="codebuild-$(date +%s)"

            echo "ASSUME_ROLE_ARN=${ASSUME_ROLE}"
            aws sts assume-role --role-arn ${ASSUME_ROLE} --role-session-name ${ASSUME_SESSION_NAME} --output json > config.json

      build:
        commands:
          - |
            echo "Set up eks config ..."
            export AWS_ACCESS_KEY_ID_OLD=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY_OLD=${AWS_SECRET_ACCESS_KEY}
            export AWS_SESSION_TOKEN_OLD=${AWS_SESSION_TOKEN}

            export AWS_ACCESS_KEY_ID=$(cat config.json | jq ".Credentials.AccessKeyId" | tr -d '"')
            export AWS_SECRET_ACCESS_KEY=$(cat config.json | jq ".Credentials.SecretAccessKey" | tr -d '"')
            export AWS_SESSION_TOKEN=$(cat config.json | jq ".Credentials.SessionToken" | tr -d '"')

            aws eks --region ${REGION_NAME} update-kubeconfig --name $CLUSTER_NAME

          - |
            echo "### Deploy k8s manifest file"
            kubectl config current-context
            kubectl get pod -A  

            cd k8s-manifests
            cat deployment-template.yaml | envsubst > deployment.yaml
            cat ingress-template.yaml | envsubst > ingress.yaml

            cat deployment.yaml
            cat ingress.yaml

            kubectl apply -f deployment.yaml
            kubectl rollout status deployment deployment-demo -n demo

            kubectl apply -f svc.yaml
            kubectl apply -f ingress.yaml

          # - cd ${CODEBUILD_SRC_DIR}

          # - |
          #   echo "### Deploy helm chart"

          #   cd helm
          #   cat ./values-template.yaml | envsubst > ./demo/values.yaml

          #   cat ./demo/values.yaml
          #   helm upgrade --install -n test demo ./demo -f ./demo/values.yaml
          #   kubectl rollout status deployment deployment-demo -n test

      post_build:
        commands:
          - |
            cd ${CODEBUILD_SRC_DIR}
            echo "Deploy image tag : ${IMAGE_TAG}" > deploy_output.txt
    artifacts:
      files:
        - deploy_output.txt
    ```
    
- íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìƒíƒœ í™•ì¸í•©ë‹ˆë‹¤.
    - ì‹¤íŒ¨â€¦ğŸ¥¹
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%206.png)
    
    - ë¡œê·¸ í™•ì¸í•˜ì—¬ ì›ì¸ì„ íŒŒì•…í•©ë‹ˆë‹¤.
        
        ```
        Error Message: parameter does not exist: /eks/role/arn...
        ```
        
    
- aws cli ë¥¼ í†µí•´ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í•„ìš”í•œ Parameterë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
(/eks/role/arn , /base/pub/subnet/a , /base/pub/subnet/c)
   > ì´ë•Œ role arnì€ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•œ cloud9ì—ì„œ ì‚¬ìš©í•˜ëŠ” role arn ì…ë ¥í•©ë‹ˆë‹¤.
   ```bash
   aws ssm put-parameter --name /eks/role/arn --value <ROLE_ARN> --type String --region $AWS_REGION --overwrite
   aws ssm put-parameter --name /base/pub/subnet/a --value <PUB_SUB_A> --type String --region $AWS_REGION --overwrite
   aws ssm put-parameter --name /base/pub/subnet/c --value <PUB_SUB_C> --type String --region $AWS_REGION --overwrite
   ```
   <img width="1513" alt="image" src="https://github.com/koDaegon/book-sample/assets/47220755/0364fcb6-7ad1-4b87-9686-daacec970c40">

   
- Codepipelineì„ ë‹¤ì‹œ íŠ¸ë¦¬ê±° í•˜ì—¬ Applicationì„ ë°°í¬í•©ë‹ˆë‹¤.
    - ì‹¤íŒ¨â€¦ğŸ˜¡
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%206.png)
    
    - ë¡œê·¸ í™•ì¸
        
        ```
        Error Message:An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:sts::181910782896:assumed-role/pipeline-role/AWSCodeBuild-4d693c1d-d830-4c90-bdf6-f28313c51ad1 is not authorized to perform: sts:AssumeRole on resource...

        ```

        
+========================================================================+        
### Challange ğŸš§ ìœ„ ì• ëŸ¬ë¥¼ í•´ê²°í•˜ì—¬ Pipelineì˜ ëª¨ë“  ë‹¨ê³„ë¥¼ í†µê³¼í•˜ì—¬ ë°°í¬ì— ì„±ê³µí•˜ì„¸ìš”!(25min)
+========================================================================+        

    
- c9ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì‹¤ì œë¡œ Book Namespaceì— ë¦¬ì†ŒìŠ¤ê°€ ì˜ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    
    ```yaml
    #Deployment ìƒíƒœ í™•ì¸
    $ kubectl get po -n book
    $ kubectl logs <pod_name> -n book
    
    #Ingress ìƒíƒœ í™•ì¸
    $ kubectl get ingress -n book
    $ kubectl describe ingress ingress-demo -n book
    ```
    
    - ingress ì„¤ì •ì´ ì˜ëª» ì„¤ì • ë¨.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%209.png)
    
- ingress-tample.yaml ë¡œ ì´ë™í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¹˜í™˜ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½ í›„ í‘¸ì‹œí•©ë‹ˆë‹¤.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%2010.png)
    
    ```yaml
    $ git add .
    $ git commit -m "Updated ingress"
    $ git push origin main
    ```
    

- ë°°í¬ ì™„ë£Œ í›„ c9ë¡œ ëŒì•„ê°€ì„œ ingress ìƒíƒœë¥¼ í™•ì¸ í•©ë‹ˆë‹¤.
    
    ```yaml
    $ kubectl get ingress -n book
    ```
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%2011.png)
    
    
    

- 3ë¶„ ì •ë„ ê¸°ë‹¤ë¦° í›„ ALB DNSë¡œ ì ‘ì†í•˜ì—¬ appì´ ì •ìƒì ìœ¼ë¡œ ë°°í¬ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. (/swagger-ui/index.html)
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/Untitled%2012.png)


   <aside>
    ğŸ’¡ ë§Œì•½  Deploymentì˜ Replica ê°¯ìˆ˜ë§Œ ë°”ê¾¸ê³  ì‹¶ë‹¤ê±°ë‚˜ í˜¹ì€ Ingressì˜ ì„¤ì •ë§Œ ë³€ê²½í•˜ê³ ì í• ë•Œ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•´ì•¼ í• ê¹Œìš”??
    </aside>
