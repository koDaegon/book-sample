# ì‹¤ìŠµ

### ArgoCD ì„¤ì •

- Argocd ì„¤ì¹˜ & ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
    
    ```
    kubectl create namespace argocd
    kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    ```
    
- Argocd cli ì„¤ì¹˜
    
    ```
    cd ~/environment
    VERSION=$(curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
    
    sudo curl --silent --location -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/$VERSION/argocd-linux-amd64
    
    sudo chmod +x /usr/local/bin/argocd
    ```
    
- argocd-server expose
    
    ```
    kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
    ```
    
    ```
    export ARGOCD_SERVER=`kubectl get svc argocd-server -n argocd -o json | jq --raw-output .status.loadBalancer.ingress[0].hostname`
    echo $ARGOCD_SERVER
    ```
    
- Retrieve initial pwd for argoCD
    
    ```
    ARGO_PWD=`kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d`
    echo $ARGO_PWD
    ```
    
- ARGO_SERVERë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ì˜¤í”ˆ í•˜ê³  adminìœ ì €ë¡œ ë¡œê·¸ì¸
    
    ![Untitled](image/2-Untitled%200.png)
    

- argoCD ì ‘ì† IAM User ìƒì„±
    
    ![Untitled](image/2-Untitled%201.png)
    

- **HTTPS Git credentials for AWS CodeCommit ìƒì„± í›„ Password ë©”ëª¨**
    
    ![Untitled](image/2-Untitled%202.png)
    

### Helm Chart Repo ìƒì„±

- Helm chart repoë¥¼ ìœ„í•œ CodeCommit ë ˆí¬ ìƒì„± í›„ [README.md](http://README.md) íŒŒì¼ ìƒì„±
    
    ![Untitled](image/2-Untitled%203.png)
    

- í•´ë‹¹ ë ˆí¬ë¥¼ c9 í™˜ê²½ìœ¼ë¡œ clone
    
    ```yaml
    $ git clone https://git-codecommit.ap-northeast-2.amazonaws.com/v1/repos/book-sample-chart
    ```
    

- book-sampleì˜ helm/book í´ë”ë¥¼ book-sample-chartë¡œ ë³µì‚¬ í›„ push
    
    ```yaml
    $ git add .
    $ git commit -m "Updated book-sample chart"
    $ git push origin main
    ```
    

<aside>
ğŸ’¡ **Chart Repoì— pushë„ í–ˆëŠ”ë°  ë‹¤ìŒ í•„ìš”í•œ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”???**

</aside>

### argoCD Chart Repo ì—°ë™

- argoCDë¡œ ì´ë™í•˜ì—¬ Setting > Repositoryë¡œ ì´ë™ í›„ Connnect Repoë¥¼ í†µí•´ CodeCommit ë ˆí¬ ì—°ë™
- VIA HTTPS ë°©ì‹ìœ¼ë¡œ ì—°ê²°í•œ í›„ ì €ì¥í•´ë†“ì€ username ë° password ì…ë ¥
    
    ![Untitled](image/2-Untitled%204.png)
    
    ![Untitled](image/2-Untitled%205.png)
    

### argoCD app ìƒì„±

- ì—°ê²°í•œ CodeCommitì„ Repo URLë¡œ ì…ë ¥í•œ í›„ argoCD Appì„ ìƒì„±

![Untitled](image/2-Untitled%206.png)

### íŒŒì´í”„ë¼ì¸ ìˆ˜ì •

- ê¸°ì¡´ ë°°í¬ ì‘ì—…ì„ argoCDì—ì„œ ëŒ€ì²´í•˜ê¸° ë•Œë¬¸ì— íŒŒì´í”„ë¼ì¸ ìˆ˜ì •
    
    
    ![Untitled](image/2-Untitled%207.png)
    

### ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ì— image tag ì—…ë°ì´íŠ¸ ì¶”ê°€

- ê¸°ì¡´ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ  ì°¨íŠ¸ ë ˆí¬ì— Codebuildì—ì„œ Image tagë¥¼ ì—…ë°ì´íŠ¸ í•  ìˆ˜ ìˆë„ë¡ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³€ê²½
    
    ```yaml
    version: 0.2
    env:
      shell: bash
      git-credential-helper: yes
      parameter-store:
        PUB_SUB_A: /base/pub/subnet/a
        PUB_SUB_C: /base/pub/subnet/c
      variables:
        REGION: "ap-northeast-2"
        IMAGE_TAG_KEY: "/book/sample/main/tag"
        GIT_EMAIL: "codecommit/email"
    phases:
      install:
        runtime-versions:
          java: corretto11
        commands:
          - apt-get update
          - apt-get install -y jq
      pre_build:
        commands:
          - echo "Print awscli version"
          - aws --version
          - export MY_ECR="${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com/${ECR_REPO}"
          - echo "### SRC_VERISON-> ${CODEBUILD_RESOLVED_SOURCE_VERSION} | Logginging to ECR"
          - docker login --username AWS -p $(aws ecr get-login-password --region ${REGION}) ${MY_ECR}
          - export TAG=${CODEBUILD_RESOLVED_SOURCE_VERSION}
          - export TAG=$(echo $TAG | sed -e "s/\.//g"| tr '[:upper:]' '[:lower:]')
          - export TAG=$(echo "${TAG:0:8}")
          - export IMAGE_TAG="${TAG}"
          - export REPOSITORY_URI="${MY_ECR}"
          - echo "## TAG-> ${TAG}"
          - |
            echo "### Start App build ###"
            chmod +x ./gradlew 
            ./gradlew clean build  -x test --no-daemon
      build:
        commands:
          - |
            echo "### Building Container Image ###"
            echo $CODEBUILD_SRC_DIR
            echo Build started on `date`
            echo Building the Docker image...
            docker build -t $REPOSITORY_URI:latest ./
            docker images
            docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
    
          - |
            echo "### Pushing Container Image ###"
            docker push $REPOSITORY_URI:$IMAGE_TAG
          # - cat ./build_scripts/imageDef.json | envsubst > $CODEBUILD_SRC_DIR/imagedefinitions.json
          # - cat $CODEBUILD_SRC_DIR/imagedefinitions.json
      post_build:
        commands:
          - |
            echo "### Pushing Container Image Tag to SSM###"
            aws ssm put-parameter --name $IMAGE_TAG_KEY --value $IMAGE_TAG --overwrite
          - echo "${IMAGE_TAG}" >> build_output.txt
          - git config --global --replace-all credential.helper '!aws codecommit credential-helper $@'
          - |
            echo "### Update value to manifest repo"
    
            git clone https://git-codecommit.ap-northeast-2.amazonaws.com/v1/repos/book-sample-chart
            cd book-sample-chart
            cd book
            cat values-template.yaml | envsubst > values.yaml
            cat values.yaml
            git status
            git config user.email "kdaegon@amazon.com"
            git config user.name "Daegon"
            git add .
            git commit -m "Updated image tag to $IMAGE_TAG"
            git log --oneline
            git remote -v
            git push -u origin main
    artifacts:
      files:
        - build_output.txt
    cache:
      paths:
        - '/root/.gradle/caches/**/*'
    ```
    

### argoCDì—ì„œ Image tag í™•ì¸

- chart repo ë° SSM ê·¸ë¦¬ê³  argoCD ìƒì—ì„œ ê°™ì€ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ì‚¬ìš©ì¤‘ì¸ì§€ í™•ì¸
    - ì°¨íŠ¸ ë ˆí¬
        
        ![Untitled](image/2-Untitled%208.png)
        
    - Parameter Store
        
        ![Untitled](image/2-Untitled%209.png)
        
    - argoCD
        
        ![Untitled](image/2-Untitled%2010.png)