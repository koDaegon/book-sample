### Helm ì´ë€
> [ì°¸ì¡°ì‚¬ì´íŠ¸](https://helm.sh/ko/docs/)
- helmì´ë€ ì¿ ë²„ë„¤í‹°ìŠ¤ íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ì…ë‹ˆë‹¤. centOSì—ì„œ yum ì´ë‚˜ pythonì—ì„œëŠ” pip íˆ´ MAC OSì—ì„œëŠ” brewì™€ ê°™ì´ íŒ¨í‚¤ì§€ë¥¼ ê´€ë¦¬ ì£¼ëŠ” íˆ´ì…ë‹ˆë‹¤. helmì„ ì´ìš©í•˜ë©´ ì›í•˜ëŠ” íŒ¨í‚¤ì§€ë“¤ì„ ì¿ ë²„ë„¤í‹°ìŠ¤ì— ì‰½ê²Œ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 


- helmì€ docker hubì™€ ë¹„ìŠ·í•˜ê²Œ helm íŒ¨í‚¤ì§€ë“¤ì„ ì €ì¥í•˜ê³  ìˆëŠ” ì €ì¥ì†Œ(repository)ê°€ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ì €ì¥ì†Œë¥¼ ì¶”ê°€í•˜ê³  í•´ë‹¹ ì €ì¥ì†Œì˜ íŒ¨í‚¤ì§€ë¥¼ installí•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. helm ì°¨íŠ¸ë¡œ ì›í•˜ëŠ” íŒ¨í‚¤ì§€ë¥¼ installí• ë•Œ values.yaml ì„ ì´ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ í™˜ê²½ì— ë”°ë¼ ì»¤ìŠ¤í…€í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


helm chart êµ¬ì¡°
- Chart.yaml: ì°¨íŠ¸ ì´ë¦„, ë²„ì „ë“± ê¸°ë³¸ì ì¸ ë©”íƒ€ ì •ë³´ë¥¼ ì •ì˜í•˜ëŠ” íŒŒì¼
- templates: ì¿ ë²„ë„¤í‹°ìŠ¤ì— ë°°í¬ë  ë¦¬ì†ŒìŠ¤ë“¤ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í…œí”Œë¦¿ì´ í¬í•¨ëœ í´ë”
- values.yaml: í…œí”Œë¦¿ì— ì‚¬ìš©ë  ë³€ìˆ˜(Value)ê°’ë“¤ì„ ì •ì˜í•˜ëŠ” íŒŒì¼

- Helm ì„¤ì¹˜

  ```bash
  curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
  chmod 700 get_helm.sh
  ./get_helm.sh
  ```
  
### Helm Chart Repo ìƒì„±

- Helm chart repoë¥¼ ìœ„í•œ CodeCommit ë ˆí¬ ìƒì„± í›„ [README.md](http://README.md) íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/2-Untitled%203.png)
    

- í•´ë‹¹ ë ˆí¬ë¥¼ c9 í™˜ê²½ìœ¼ë¡œ í´ë¡  í•©ë‹ˆë‹¤.
    
    ```yaml
    $ git clone https://git-codecommit.ap-northeast-2.amazonaws.com/v1/repos/book-sample-chart
    ```
    

### ArgoCD ì„¤ì •

- ArgoCD ì„¤ì¹˜ & ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±í•©ë‹ˆë‹¤.
    
    ```
    kubectl create namespace argocd
    kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    ```
    
- ì™¸ë¶€ì—ì„œ ArgoCDì— ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ CLBë¥¼ ìƒì„±í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    
    ```
    kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
    ```

- ArgoCD ì ‘ì† ì£¼ì†Œë¥¼ í™•ì¸ í•©ë‹ˆë‹¤.
    ```
    export ARGOCD_SERVER=`kubectl get svc argocd-server -n argocd -o json | jq --raw-output .status.loadBalancer.ingress[0].hostname`
    echo $ARGOCD_SERVER
    ```
    
- ì´ˆê¸° admin ì‚¬ìš©ì ì•”í˜¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
    
    ```
    ARGO_PWD=`kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d`
    echo $ARGO_PWD
    ```
    
- ARGO_SERVERë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ì˜¤í”ˆ í•˜ê³  adminìœ ì €ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/2-Untitled%200.png)
    

- ArgoCDê°€ ë ˆí¬ì§€í† ë¦¬ì— ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ IAM User ë° Git Credentialì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/2-Untitled%201.png)



   > CodeCommit ë ˆí¬ì§€í† ë¦¬ì— ì ‘ê·¼ í•  ìˆ˜ ìˆë„ë¡ AWSCodeCommitPowerUser ê¶Œí•œì„ í• ë‹¹ í•©ë‹ˆë‹¤.
  
  <img width="1320" alt="image" src="https://github.com/koDaegon/book-sample/assets/47220755/3d479156-19ff-4e3f-84d6-4f28304a24ca">

    
    > IAM Userì˜ ë³´ì•ˆ ìê²© ì¦ëª…ìœ¼ë¡œ ì´ë™í•˜ì—¬ Git Credentialì„ ìƒì„± í•œ í›„ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ë‹¤ë¥¸ ê³³ì— ë©”ëª¨í•©ë‹ˆë‹¤.

    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/2-Untitled%202.png)
    


### ArgoCD Chart Repo ì—°ë™

ArgoCDë¡œ ì´ë™í•˜ì—¬ Setting > Repositoryë¡œ ì´ë™ í›„ Connnect Repoë¥¼ í†µí•´ CodeCommit ë ˆí¬ì§€í† ë¦¬ë¥¼ ì—°ë™í•©ë‹ˆë‹¤.
- `VIA HTTPS` ë°©ì‹ìœ¼ë¡œ ë° `default` í”„ë¡œì íŠ¸ ì„¤ì • í›„ ì €ì¥í•´ë†“ì€ username ë° password ì…ë ¥í•˜ì—¬ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/2-Untitled%204.png)
    
    ![Untitled](https://github.com/koDaegon/book-sample/blob/1aa70009590b9f5a94f4413747a20972ec995a73/docs/Image/2-Untitled%205.png)
    

### ArgoCD Application ìƒì„±

- helm/game-2048 í´ë” í•˜ìœ„ (`templates/` , `Chart.yaml`, `values.yaml`)íŒŒì¼ì„ Chart ë ˆí¬ì§€í† ë¦¬ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.

  ```
  cd ~/environment
  mkdir chart-repo/game-2048
  cp -r book-sample/helm/game-2048/* chart-repo/game-2048
  ```

- Chart ë ˆí¬ì§€í† ë¦¬ì— ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•œ í›„ í‘¸ì‹œ í•©ë‹ˆë‹¤.

  ```
  cd chart-repo
  git add .
  git commit -m "Updated game chart"
  git push origin main
  ```
  
- Application íƒ­ìœ¼ë¡œ ì´ë™ í›„ `default` í”„ë¡œì íŠ¸, `Manual` SYNC POLICY, ê¸°ì¡´ ì„¤ì •í•œ Repository URL, `game-2048` Path, ê¸°ë³¸ Cluster URLì„ ì„ íƒí•œ ë‹¤ìŒ ArgoCD Appì„ ìƒì„±í•©ë‹ˆë‹¤.

  <img width="1314" alt="image" src="https://github.com/koDaegon/book-sample/assets/47220755/f0b07eb8-725c-42d2-b083-3aebdfe3016e">

- Application ìœ¼ë¡œ ì´ë™í•˜ì—¬ Chart ë ˆí¬ì§€í† ë¦¬ì™€ Syncë¥¼ ë§ì¶° ì¤ë‹ˆë‹¤.

    <img width="1434" alt="image" src="https://github.com/koDaegon/book-sample/assets/47220755/f0452c9f-d2a4-45fd-b32d-9768c112c254">


- 3~4ë¶„ í›„ ingressë¥¼ í†µí•˜ì—¬ ALBê°€ í”„ë¡œë¹„ì €ë‹ ëœ í›„ ALB DNSë¥¼ í†µí•˜ì—¬ ë¸Œë¼ìš°ì €ì— ì ‘ì†í•©ë‹ˆë‹¤.
    <img width="1395" alt="image" src="https://github.com/koDaegon/book-sample/assets/47220755/13594a3b-4b36-4275-b735-7298649ce830">


- `Values.yaml`ì— ReplicaSet ê°¯ìˆ˜ë¥¼ ë³€ê²½ í›„ Chart ë ˆí¬ì— í‘¸ì‹œí•©ë‹ˆë‹¤.

  <img width="463" alt="image" src="https://github.com/koDaegon/book-sample/assets/47220755/141477eb-a0bf-4761-844d-e1ce30c39117">


  ```
  git add .
  git commit -m "Updated replicas to 4"
  git push origin main
  ```
- ArgoCDë¡œ ì´ë™í•˜ì—¬ Applicationì„ Sync í›„ ë³€ê²½ëœ replica ê°¯ìˆ˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
  
    <img width="1430" alt="image" src="https://github.com/koDaegon/book-sample/assets/47220755/8d8d6142-ccae-4344-be3b-1902d61197be">
    <img width="1436" alt="image" src="https://github.com/koDaegon/book-sample/assets/47220755/99047c57-4f17-406a-ad9e-67646cc03050">


<aside>
ğŸ’¡Book-Sample api ë ˆí¬ì—ì„œ ArgoCDë¥¼ ì´ìš©í•œ GitOps í˜•íƒœì˜ ì§€ì†ì  ë°°í¬ë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•´ì„  ì–´ë–¤ ì‘ì—…ì´ í•„ìš”í• ê¹Œìš”??
</aside>     
